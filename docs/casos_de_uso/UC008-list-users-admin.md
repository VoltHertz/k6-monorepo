# UC008 - List Users (Admin)

> **Status**: ‚úÖ Approved  
> **Prioridade**: P2 (Secund√°rio)  
> **Complexidade**: 2 (Simples)  
> **Sprint**: Sprint 5 (Semana 8)  
> **Esfor√ßo Estimado**: 5h  

---

## üìã Descri√ß√£o

### Perfil de Usu√°rio
- **Tipo**: Administrador (Persona 3)
- **Distribui√ß√£o de Tr√°fego**: 10% do total esperado (backoffice operations)
- **Objetivo de Neg√≥cio**: Gerenciar base de usu√°rios da plataforma atrav√©s de listagem paginada, busca e filtros para opera√ß√µes administrativas (modera√ß√£o, suporte, an√°lise)

### Contexto
Este caso de uso representa opera√ß√µes **administrativas de gest√£o de usu√°rios** conforme descrito em `fase1-perfis-de-usuario.md` (Persona 3 - Administrador/Moderador). O administrador:
1. Autentica com credenciais admin ‚Üí POST /auth/login
2. Lista todos os usu√°rios (paginado) ‚Üí GET /users
3. Busca usu√°rios espec√≠ficos ‚Üí GET /users/search?q={query}
4. Filtra usu√°rios por crit√©rios ‚Üí GET /users/filter?key={key}&value={value}
5. Visualiza detalhes de usu√°rio espec√≠fico ‚Üí GET /users/{id}

Este UC foca em **opera√ß√µes READ de administra√ß√£o**, essenciais para:
- **Modera√ß√£o**: Identificar usu√°rios problem√°ticos
- **Suporte**: Localizar usu√°rios para assist√™ncia
- **An√°lise**: Entender demografia e comportamento da base
- **Compliance**: Auditar dados de usu√°rios

### Valor de Neg√≥cio
- **Criticidade**: Secund√°ria (2/5) - Backoffice, n√£o afeta UX do cliente final
- **Impacto no Tr√°fego**: 10% do volume total (Persona 3 Admin/Moderador)
- **Operacional**: Cr√≠tico para time interno (CS, moderation, analytics)
- **Compliance**: Necess√°rio para LGPD/GDPR (acesso/auditoria de dados)
- **Quadrante na Matriz**: üîÑ **QUICK WINS** (Baixa criticidade, Baixa complexidade)

**Fonte**: `docs/casos_de_uso/fase1-perfis-de-usuario.md` - Persona 3 (Admin: 10% do tr√°fego, 10-30 min sess√£o, 5-10s think time)

---

## üîó Endpoints Envolvidos

| M√©todo | Endpoint | SLO Individual | Observa√ß√µes |
|--------|----------|----------------|-------------|
| POST | `/auth/login` | P95 < 400ms | Step 0: Autentica√ß√£o admin (UC003) |
| GET | `/users` | P95 < 500ms | Step 1: Listar todos (paginado, default 30 itens) |
| GET | `/users?limit={n}&skip={m}` | P95 < 500ms | Step 2: Pagina√ß√£o customizada |
| GET | `/users/search?q={query}` | P95 < 650ms | Step 3: Busca por nome/email/username |
| GET | `/users/filter?key={k}&value={v}` | P95 < 650ms | Step 4: Filtro por propriedades (ex: gender, role) |
| GET | `/users/{id}` | P95 < 450ms | Step 5: Detalhes de usu√°rio espec√≠fico |
| GET | `/users?select={fields}` | P95 < 450ms | Step 6 (Opcional): Sele√ß√£o de campos espec√≠ficos |

**Total de Endpoints**: 7 (6 principais + 1 opcional)  
**Opera√ß√µes READ**: 7 (100%)  
**Opera√ß√µes WRITE**: 0  

**Fonte**: `docs/casos_de_uso/fase1-inventario-endpoints.csv` - Users domain (GET operations)

---

## üìä SLOs (Service Level Objectives)

| M√©trica | Threshold | Rationale |
|---------|-----------|-----------|
| `http_req_duration{feature:users}` (P95) | < 500ms | Baseline Users: P95 real = 320ms, +56% margem para queries complexas |
| `http_req_duration{feature:users}` (P99) | < 700ms | Worst case: search/filter com payload grande |
| `http_req_failed{feature:users}` | < 1% | Toler√¢ncia para usu√°rios inexistentes (404) ou queries inv√°lidas |
| `checks{uc:UC008}` | > 99% | Opera√ß√µes admin devem ter alta confiabilidade |
| `users_list_duration_ms` (P95) | < 500ms | M√©trica customizada: lat√™ncia de listagem |
| `users_search_duration_ms` (P95) | < 650ms | M√©trica customizada: lat√™ncia de busca (+30% vs list) |
| `users_filter_duration_ms` (P95) | < 650ms | M√©trica customizada: lat√™ncia de filtros complexos |

**Baseline de Refer√™ncia**: 
- `docs/casos_de_uso/fase1-baseline-slos.md` - Users: GET /users P95=220ms, GET /users/search P95=280ms, GET /users/filter P95=260ms
- Margem de 56% aplicada considerando carga admin (pagina√ß√£o extensa, filtros complexos)

**Observa√ß√µes**:
- Search/Filter t√™m SLO +30% vs List devido a processamento de queries
- Admin operations toleram lat√™ncia maior (5-10s think time vs 2-5s visitante)
- Payload de /users pode ser grande (30 usu√°rios com 20+ campos cada = ~50KB)

---

## üì¶ Dados de Teste

### Arquivos Necess√°rios

| Arquivo | Localiza√ß√£o | Volume | Fonte | Estrat√©gia de Refresh |
|---------|-------------|--------|-------|----------------------|
| `admin-credentials.json` | `data/test-data/` | 5 admins | UC003 (reutilizado) | Mensal |
| `user-ids-sample.json` | `data/test-data/` | 50 user IDs | Gerado de fulldummyjsondata/users.json | Mensal |
| `user-search-queries.json` | `data/test-data/` | 20 queries | Manual (nomes comuns: John, Emily, etc.) | Trimestral |
| `user-filter-criteria.json` | `data/test-data/` | 10 filtros | Manual (gender=male, role=admin, etc.) | Trimestral |

### Gera√ß√£o de Dados
```bash
# Gerar lista de user IDs (sample de 50 dos 208 totais)
node data/test-data/generators/generate-user-ids.ts \
  --source data/fulldummyjsondata/users.json \
  --output data/test-data/user-ids-sample.json \
  --sample-size 50

# Gerar queries de busca comuns
cat > data/test-data/user-search-queries.json << EOF
[
  {"term": "John", "expected_min": 1},
  {"term": "Emily", "expected_min": 1},
  {"term": "admin", "expected_min": 1},
  {"term": "johnson", "expected_min": 1},
  {"term": "@x.dummyjson.com", "expected_min": 10}
]
EOF

# Gerar crit√©rios de filtro
cat > data/test-data/user-filter-criteria.json << EOF
[
  {"key": "gender", "value": "male"},
  {"key": "gender", "value": "female"},
  {"key": "role", "value": "admin"},
  {"key": "role", "value": "moderator"},
  {"key": "hair.color", "value": "Brown"},
  {"key": "age", "value": "28"}
]
EOF
```

### Depend√™ncias de Dados
- **UC003**: `admin-credentials.json` (credenciais de administradores)
- **Novo**: `user-ids-sample.json`, `user-search-queries.json`, `user-filter-criteria.json` (gerados para UC008)

**Estrat√©gia**: Gerar novos arquivos espec√≠ficos para opera√ß√µes admin (IDs, queries, filtros)

---

## üîÑ Fluxo Principal

### Pr√©-condi√ß√µes
- Usu√°rio possui **credenciais de administrador** (role: "admin")
- API DummyJSON dispon√≠vel em https://dummyjson.com
- Dados de teste carregados (admin credentials, user IDs, queries, filters)
- Token de autentica√ß√£o admin v√°lido (obtido via UC003)

### Steps

**Step 0: Autentica√ß√£o Admin (Pr√©-requisito)**  
```http
POST /auth/login
Headers:
  Content-Type: application/json
Body:
{
  "username": "emilys",
  "password": "emilyspass",
  "expiresInMins": 60
}
```

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'has access token'` ‚Üí Response cont√©m `accessToken`
- ‚úÖ `'user is admin'` ‚Üí Response cont√©m `role: "admin"`

**Think Time**: 5-10s (an√°lise de dados - Persona 3 Admin)

**Fonte**: UC003 (User Login & Profile) - Step 1, com valida√ß√£o adicional de role admin

---

**Step 1: Listar Todos os Usu√°rios (Pagina√ß√£o Default)**  
```http
GET /users
Headers:
  Content-Type: application/json
  Authorization: Bearer ${accessToken}
```

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'has users array'` ‚Üí Response cont√©m array `users`
- ‚úÖ `'users count is 30'` ‚Üí `users.length` === 30 (default pagination)
- ‚úÖ `'has pagination metadata'` ‚Üí Response cont√©m `total`, `skip`, `limit`
- ‚úÖ `'total is 208'` ‚Üí Campo `total` = 208 (total de usu√°rios DummyJSON)

**Think Time**: 5-10s (an√°lise de lista)

**Fonte**: `dummyjson.com_docs_users.md` - Get all users (default 30 items)

---

**Step 2: Pagina√ß√£o Customizada (Limit e Skip)**  
```http
GET /users?limit=10&skip=20
Headers:
  Content-Type: application/json
  Authorization: Bearer ${accessToken}

# Exemplo concreto: pegar 10 usu√°rios a partir do √≠ndice 20
```

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'users count is 10'` ‚Üí `users.length` === 10
- ‚úÖ `'skip is 20'` ‚Üí Campo `skip` = 20
- ‚úÖ `'limit is 10'` ‚Üí Campo `limit` = 10
- ‚úÖ `'first user id is 21'` ‚Üí `users[0].id` = 21 (20 pulados + 1)

**Think Time**: 5-10s (navega√ß√£o entre p√°ginas)

**Fonte**: `dummyjson.com_docs_users.md` - Limit and skip users

---

**Step 3: Buscar Usu√°rios por Termo**  
```http
GET /users/search?q={query}
Headers:
  Content-Type: application/json
  Authorization: Bearer ${accessToken}

# Exemplo concreto:
GET /users/search?q=John
```

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'has users array'` ‚Üí Response cont√©m array `users`
- ‚úÖ `'has total field'` ‚Üí Response cont√©m campo `total`
- ‚úÖ `'results match query'` ‚Üí Pelo menos 1 usu√°rio retornado (se query v√°lida)
- ‚úÖ `'user matches search term'` ‚Üí `users[0].firstName` ou `lastName` cont√©m termo buscado

**Think Time**: 5-10s (an√°lise de resultados)

**Fonte**: `dummyjson.com_docs_users.md` - Search users

---

**Step 4: Filtrar Usu√°rios por Crit√©rios**  
```http
GET /users/filter?key={key}&value={value}
Headers:
  Content-Type: application/json
  Authorization: Bearer ${accessToken}

# Exemplo concreto:
GET /users/filter?key=gender&value=male
GET /users/filter?key=hair.color&value=Brown
```

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'has users array'` ‚Üí Response cont√©m array `users`
- ‚úÖ `'filter applied correctly'` ‚Üí Todos os usu√°rios retornados t√™m o valor filtrado
- ‚úÖ `'has total field'` ‚Üí Response cont√©m campo `total`
- ‚úÖ `'total matches filter'` ‚Üí `total` >= `users.length`

**Think Time**: 5-10s (an√°lise de dados filtrados)

**Fonte**: `dummyjson.com_docs_users.md` - Filter users (key/value com suporte a nested keys)

---

**Step 5: Visualizar Detalhes de Usu√°rio Espec√≠fico**  
```http
GET /users/{id}
Headers:
  Content-Type: application/json
  Authorization: Bearer ${accessToken}

# Exemplo concreto:
GET /users/1
```

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'user has id'` ‚Üí Response cont√©m campo `id`
- ‚úÖ `'user id matches'` ‚Üí `id` = ID solicitado
- ‚úÖ `'user has complete data'` ‚Üí Response cont√©m campos: `firstName`, `lastName`, `email`, `username`, `role`
- ‚úÖ `'user has address'` ‚Üí Response cont√©m objeto `address` completo
- ‚úÖ `'user has company'` ‚Üí Response cont√©m objeto `company` completo

**Think Time**: 5-10s (an√°lise detalhada de perfil)

**Fonte**: `dummyjson.com_docs_users.md` - Get a single user

---

**Step 6 (Opcional): Selecionar Campos Espec√≠ficos**  
```http
GET /users?limit=10&select=firstName,lastName,email,role
Headers:
  Content-Type: application/json
  Authorization: Bearer ${accessToken}
```

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'users count is 10'` ‚Üí `users.length` <= 10
- ‚úÖ `'only selected fields present'` ‚Üí Response cont√©m apenas `id`, `firstName`, `lastName`, `email`, `role`
- ‚úÖ `'no extra fields'` ‚Üí Campos como `address`, `company`, `bank` N√ÉO est√£o presentes

**Think Time**: 5-10s (otimiza√ß√£o de payload)

**Fonte**: `dummyjson.com_docs_users.md` - Limit and skip users (select parameter)

---

### P√≥s-condi√ß√µes
- Administrador visualizou/listou usu√°rios conforme necessidade
- Opera√ß√µes de pagina√ß√£o, busca e filtro validadas
- Dados de usu√°rios acessados para modera√ß√£o/suporte/an√°lise
- M√©tricas customizadas `users_*` coletadas
- Token permanece v√°lido para pr√≥ximas opera√ß√µes admin (cache reutiliz√°vel)

---

## üîÄ Fluxos Alternativos

### Cen√°rio de Erro 1: Credenciais N√£o-Admin
**Condi√ß√£o**: Usu√°rio tenta acessar /users mas n√£o √© admin (role: "user" ou "moderator")

**Steps**:
1. Login com credenciais de usu√°rio comum (role: "user")
2. Request GET /users ‚Üí API permite (DummyJSON n√£o valida role)
3. VU registra sucesso mas valida role incorreta

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí DummyJSON permite qualquer autenticado
- ‚ö†Ô∏è `'user is not admin'` ‚Üí Response login tem `role !== "admin"`

**Observa√ß√£o**: DummyJSON **n√£o** restringe acesso por role. Em produ√ß√£o real, deveria retornar 403 Forbidden.

---

### Cen√°rio de Erro 2: Usu√°rio Inexistente
**Condi√ß√£o**: GET /users/{id} com ID que n√£o existe (ex: ID 999)

**Steps**:
1. Request GET /users/999
2. API retorna 404 Not Found
3. VU registra erro esperado

**Valida√ß√µes**:
- ‚ùå `'status is 404'` ‚Üí Status code = 404
- ‚úÖ `'error message present'` ‚Üí Response cont√©m mensagem de erro
- ‚úÖ `'message is not found'` ‚Üí Mensagem cont√©m "not found"

**M√©trica**: `users_errors` incrementada

---

### Cen√°rio de Erro 3: Query de Busca Vazia
**Condi√ß√£o**: GET /users/search?q= (query vazia)

**Steps**:
1. Request GET /users/search?q=
2. API retorna 200 OK com array vazio ou todos os usu√°rios (comportamento n√£o documentado)
3. VU valida resposta

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'has users array'` ‚Üí Response cont√©m array `users`
- ‚ö†Ô∏è `'behavior documented'` ‚Üí Registrar comportamento real (vazio ou todos)

**Observa√ß√£o**: Comportamento de query vazia n√£o est√° especificado na documenta√ß√£o DummyJSON.

---

### Edge Case 1: Filtro com Nested Keys
**Condi√ß√£o**: Filtrar por propriedades aninhadas (ex: hair.color, address.city)

**Steps**:
1. Request GET /users/filter?key=hair.color&value=Brown
2. API aplica filtro em nested property
3. VU valida que todos os usu√°rios retornados t√™m `hair.color === "Brown"`

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'nested filter works'` ‚Üí `users[0].hair.color` === "Brown"
- ‚úÖ `'all match criteria'` ‚Üí Todos os usu√°rios validados

**Fonte**: `dummyjson.com_docs_users.md` - Filter users (suporta nested keys com ".")

---

### Edge Case 2: Pagina√ß√£o com limit=0
**Condi√ß√£o**: GET /users?limit=0 para obter TODOS os usu√°rios

**Steps**:
1. Request GET /users?limit=0
2. API retorna todos os 208 usu√°rios de uma vez
3. VU valida payload grande (~250KB)

**Valida√ß√µes**:
- ‚úÖ `'status is 200'` ‚Üí Status code = 200
- ‚úÖ `'users count is 208'` ‚Üí `users.length` === 208
- ‚úÖ `'total is 208'` ‚Üí Campo `total` = 208
- ‚ö†Ô∏è `'response time acceptable'` ‚Üí Lat√™ncia pode ser >1s devido a payload

**Fonte**: `dummyjson.com_docs_users.md` - Limit and skip (limit=0 to get all items)

---

## ‚öôÔ∏è Implementa√ß√£o

### Localiza√ß√£o do Teste
- **Arquivo**: `tests/api/users/list-users-admin.test.ts`
- **Diret√≥rio**: `tests/api/users/` (domain-driven structure)

### Configura√ß√£o de Cen√°rio
```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Trend, Counter } from 'k6/metrics';
import { SharedArray } from 'k6/data';
import { randomItem } from 'https://jslib.k6.io/k6-utils/1.4.0/index.js';

// Custom Metrics
const usersListDuration = new Trend('users_list_duration_ms');
const usersSearchDuration = new Trend('users_search_duration_ms');
const usersFilterDuration = new Trend('users_filter_duration_ms');
const usersErrors = new Counter('users_errors');
const usersSuccess = new Counter('users_success');

// Test Data (SharedArray)
const adminCredentials = new SharedArray('adminCredentials', function() {
  return JSON.parse(open('../../../data/test-data/admin-credentials.json'));
});

const userIds = new SharedArray('userIds', function() {
  return JSON.parse(open('../../../data/test-data/user-ids-sample.json'));
});

const searchQueries = new SharedArray('searchQueries', function() {
  return JSON.parse(open('../../../data/test-data/user-search-queries.json'));
});

const filterCriteria = new SharedArray('filterCriteria', function() {
  return JSON.parse(open('../../../data/test-data/user-filter-criteria.json'));
});

export const options = {
  scenarios: {
    list_users_admin: {
      executor: 'constant-arrival-rate',
      rate: Number(__ENV.K6_RPS) || 1, // 10% tr√°fego, baseline 5 RPS = 0.5 RPS (arredonda para 1)
      timeUnit: '1s',
      duration: __ENV.K6_DURATION || '5m',
      preAllocatedVUs: 5,
      maxVUs: 20,
      tags: { feature: 'users', kind: 'admin', uc: 'UC008' },
    },
  },
  thresholds: {
    'http_req_duration{feature:users}': ['p(95)<500', 'p(99)<700'],
    'http_req_failed{feature:users}': ['rate<0.01'],
    'checks{uc:UC008}': ['rate>0.99'],
    'users_list_duration_ms': ['p(95)<500'],
    'users_search_duration_ms': ['p(95)<650'],
    'users_filter_duration_ms': ['p(95)<650'],
  },
};

const BASE_URL = __ENV.BASE_URL || 'https://dummyjson.com';
let accessToken = null;

export function setup() {
  // Authenticate once as admin
  const admin = adminCredentials[0];
  const res = http.post(`${BASE_URL}/auth/login`, JSON.stringify({
    username: admin.username,
    password: admin.password,
    expiresInMins: 60
  }), {
    headers: { 'Content-Type': 'application/json' },
  });
  
  if (res.status === 200 && res.json('role') === 'admin') {
    return { token: res.json('accessToken') };
  }
  throw new Error('Admin authentication failed');
}

export default function(data) {
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${data.token}`
  };

  // Step 1: List all users (default pagination)
  let res = http.get(`${BASE_URL}/users`, {
    headers: headers,
    tags: { name: 'list_users_default', uc: 'UC008', step: '1' }
  });
  
  usersListDuration.add(res.timings.duration);
  
  if (check(res, {
    'status is 200': (r) => r.status === 200,
    'has users array': (r) => Array.isArray(r.json('users')),
    'users count is 30': (r) => r.json('users').length === 30,
  }, { uc: 'UC008', step: '1' })) {
    usersSuccess.add(1);
  } else {
    usersErrors.add(1);
  }
  
  sleep(Math.random() * 5 + 5); // 5-10s think time

  // Step 2: Custom pagination
  const randomSkip = Math.floor(Math.random() * 170); // 0-170 (208 - 30 - margem)
  res = http.get(`${BASE_URL}/users?limit=10&skip=${randomSkip}`, {
    headers: headers,
    tags: { name: 'list_users_paginated', uc: 'UC008', step: '2' }
  });
  
  usersListDuration.add(res.timings.duration);
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'users count is 10': (r) => r.json('users').length === 10,
  }, { uc: 'UC008', step: '2' });
  
  sleep(Math.random() * 5 + 5);

  // Step 3: Search users
  const randomQuery = randomItem(searchQueries);
  res = http.get(`${BASE_URL}/users/search?q=${randomQuery.term}`, {
    headers: headers,
    tags: { name: 'search_users', uc: 'UC008', step: '3' }
  });
  
  usersSearchDuration.add(res.timings.duration);
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'has users array': (r) => Array.isArray(r.json('users')),
  }, { uc: 'UC008', step: '3' });
  
  sleep(Math.random() * 5 + 5);

  // Step 4: Filter users
  const randomFilter = randomItem(filterCriteria);
  res = http.get(`${BASE_URL}/users/filter?key=${randomFilter.key}&value=${randomFilter.value}`, {
    headers: headers,
    tags: { name: 'filter_users', uc: 'UC008', step: '4' }
  });
  
  usersFilterDuration.add(res.timings.duration);
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'has users array': (r) => Array.isArray(r.json('users')),
  }, { uc: 'UC008', step: '4' });
  
  sleep(Math.random() * 5 + 5);

  // Step 5: Get single user details
  const randomUserId = randomItem(userIds);
  res = http.get(`${BASE_URL}/users/${randomUserId}`, {
    headers: headers,
    tags: { name: 'get_user_details', uc: 'UC008', step: '5' }
  });
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'user has id': (r) => r.json('id') !== undefined,
    'user has complete data': (r) => r.json('firstName') && r.json('email') && r.json('role'),
  }, { uc: 'UC008', step: '5' });
  
  sleep(Math.random() * 5 + 5);
}
```

### Tags Obrigat√≥rias
```javascript
tags: { 
  feature: 'users',      // Domain area (users management)
  kind: 'admin',         // Operation type (admin operations)
  uc: 'UC008'            // Use case ID
}
```

**Fonte**: `docs/casos_de_uso/templates/guia-de-estilo.md` - Tags k6 obrigat√≥rias

---

## üß™ Comandos de Teste

### Execu√ß√£o Local
```bash
# Smoke test (valida√ß√£o r√°pida - 1 admin op/s por 30s)
K6_RPS=1 K6_DURATION=30s k6 run tests/api/users/list-users-admin.test.ts

# Baseline (5 min, 1 RPS = 10% de 5 RPS baseline)
K6_RPS=1 K6_DURATION=5m k6 run tests/api/users/list-users-admin.test.ts

# Stress (10 min, 2 RPS = 10% de 20 RPS stress)
K6_RPS=2 K6_DURATION=10m k6 run tests/api/users/list-users-admin.test.ts

# Com vari√°veis de ambiente customizadas
BASE_URL=https://dummyjson.com K6_RPS=1 K6_DURATION=3m \
  k6 run tests/api/users/list-users-admin.test.ts
```

### CI/CD
```bash
# GitHub Actions smoke test (PR validation)
# Workflow: .github/workflows/k6-pr-smoke.yml
# Executa: 1 RPS por 60s com thresholds relaxados

# GitHub Actions baseline (main branch)
# Workflow: .github/workflows/k6-main-baseline.yml
# Executa: 1 RPS por 5m com thresholds strict (SLOs completos)
```

---

## üìà M√©tricas Customizadas

### Trends (Lat√™ncia)
```javascript
import { Trend } from 'k6/metrics';

const usersListDuration = new Trend('users_list_duration_ms');
const usersSearchDuration = new Trend('users_search_duration_ms');
const usersFilterDuration = new Trend('users_filter_duration_ms');

// No VU code:
// Step 1-2 (list/pagination):
usersListDuration.add(res.timings.duration);

// Step 3 (search):
usersSearchDuration.add(res.timings.duration);

// Step 4 (filter):
usersFilterDuration.add(res.timings.duration);
```

**M√©tricas**:
- `users_list_duration_ms`: Lat√™ncia de listagem/pagina√ß√£o (P95 < 500ms)
- `users_search_duration_ms`: Lat√™ncia de busca (P95 < 650ms)
- `users_filter_duration_ms`: Lat√™ncia de filtros (P95 < 650ms)

---

### Counters (Eventos de Neg√≥cio)
```javascript
import { Counter } from 'k6/metrics';

const usersSuccess = new Counter('users_success');
const usersErrors = new Counter('users_errors');

// No VU code:
if (check(res, { ... })) {
  usersSuccess.add(1);
} else {
  usersErrors.add(1);
}
```

**M√©tricas**:
- `users_success`: Contador de opera√ß√µes admin bem-sucedidas
- `users_errors`: Contador de erros (404, query inv√°lida, etc.)

---

### Dashboards
- **Grafana**: (Futuro) Dashboard dedicado a opera√ß√µes admin com breakdown por tipo de opera√ß√£o (list/search/filter)
- **k6 Cloud**: (Futuro) An√°lise de performance de queries admin e padr√µes de uso

---

## ‚ö†Ô∏è Observa√ß√µes Importantes

### Limita√ß√µes da API
- **DummyJSON**: API p√∫blica, sem autentica√ß√£o real por role (qualquer token v√°lido pode acessar /users)
- **Sem Restri√ß√£o de Permiss√µes**: Em produ√ß√£o real, opera√ß√µes admin devem validar `role === "admin"` (403 Forbidden se n√£o)
- **Pagina√ß√£o Default**: 30 itens (n√£o configur√°vel via API, apenas via limit param)
- **Total Fixo**: 208 usu√°rios (dataset fixo, n√£o cresce com POST /users/add)
- **Filtros Case-Sensitive**: Key e value devem ter case exato (ex: "Brown" n√£o encontra "brown")

### Particularidades do Teste
- **Think Times Longos**: 5-10s entre steps (Persona 3 Admin analisa dados)
- **Autentica√ß√£o Setup**: Login admin uma vez no `setup()`, reutiliza token em todas as itera√ß√µes
- **Randomiza√ß√£o**: Skip, queries e filtros aleat√≥rios para simular variedade de opera√ß√µes
- **Payload Grande**: GET /users?limit=0 retorna ~250KB (208 usu√°rios completos)
- **Nested Keys**: Filtros suportam propriedades aninhadas com "." (ex: `hair.color`, `address.city`)
- **Select Parameter**: Reduz payload selecionando apenas campos necess√°rios (otimiza√ß√£o de banda)

### Considera√ß√µes de Desempenho
- **SharedArray**: Usar para carregar credentials/IDs/queries/filters (evita duplica√ß√£o em mem√≥ria)
- **Tags Granulares**: Cada step tem tag `step: '1'` a `'5'` para an√°lise individual
- **Open Model Executor**: `constant-arrival-rate` garante RPS constante independente de lat√™ncia
- **Setup Function**: Autentica admin uma vez, compartilha token entre VUs (evita login repetido)
- **Memory-Efficient**: Dados carregados uma vez, compartilhados entre itera√ß√µes

---

## üîó Depend√™ncias

### UCs Dependentes (Bloqueadores)
- **UC003** (User Login & Profile) ‚Üí Step 0: Autentica√ß√£o admin com valida√ß√£o de role

**Fonte**: `docs/casos_de_uso/fase2-mapa-dependencias.md` - UC008 depende de UC003 (auth admin)

### UCs que Usam Este (Fornece Para)
- **UC011** (Mixed Workload) ‚Üí Persona "Admin" (10%) executa UC008

**Fonte**: `docs/casos_de_uso/fase2-mapa-dependencias.md` - UC008 fornece para UC011

### Libs Necess√°rias
- **`libs/http/auth.ts`** (Criada em UC003) ‚Üí Login e gest√£o de tokens admin

**Fun√ß√µes Usadas de `libs/http/auth.ts`**:
```typescript
import { login, getAuthHeaders } from '../../../libs/http/auth';

// No setup():
const { token } = login(adminUsername, adminPassword);

// No VU code:
const headers = getAuthHeaders(token);
```

### Dados Requeridos
- **UC003**: `data/test-data/admin-credentials.json` (credenciais admin)
- **Novo (UC008)**: 
  - `data/test-data/user-ids-sample.json` (50 user IDs)
  - `data/test-data/user-search-queries.json` (20 queries)
  - `data/test-data/user-filter-criteria.json` (10 filtros)

**Estrat√©gia**: Reutilizar admin credentials de UC003, gerar novos arquivos para opera√ß√µes admin (IDs, queries, filtros)

---

## üìÇ Libs/Helpers Criados

### Sem Novas Libs Criadas

Este UC **reutiliza libs existentes**:

1. **`libs/http/auth.ts`** (Criada em UC003)
   - Fun√ß√µes: `login()`, `getToken()`, `getAuthHeaders()`
   - Usado para Step 0 (autentica√ß√£o admin)

**Observa√ß√£o**: UC008 √© um **caso de uso de leitura admin** que reutiliza autentica√ß√£o de UC003 sem criar novas libs. Toda a l√≥gica necess√°ria j√° existe.

---

## üìù Hist√≥rico de Mudan√ßas

| Data | Autor | Mudan√ßa |
|------|-------|---------|
| 2025-10-08 | GitHub Copilot | Cria√ß√£o inicial do UC008 (Sprint 5) - opera√ß√µes admin de listagem de usu√°rios |

---

## ‚úÖ Checklist de Completude

- [x] Perfil de usu√°rio est√° claro e realista (Persona 3 - Administrador, 10% tr√°fego)
- [x] Todos os endpoints est√£o documentados com m√©todo HTTP (7 endpoints: 1 POST + 6 GET)
- [x] SLOs est√£o definidos e justificados (refer√™ncia ao baseline Users + 56% margem)
- [x] Fluxo principal est√° detalhado passo a passo (6 steps numerados + auth)
- [x] Valida√ß√µes (checks) est√£o especificadas (checks human-readable para cada step)
- [x] Dados de teste est√£o identificados (fonte + volume) - reutiliza UC003 + novos arquivos
- [x] Headers obrigat√≥rios est√£o documentados (Content-Type + Authorization Bearer)
- [x] Think times est√£o especificados (5-10s entre steps, Persona 3)
- [x] Edge cases e cen√°rios de erro est√£o mapeados (3 cen√°rios alternativos + 2 edge cases)
- [x] Depend√™ncias de outros UCs est√£o listadas (UC003 auth)
- [x] Limita√ß√µes da API est√£o documentadas (DummyJSON sem valida√ß√£o de role real)
- [x] Arquivo nomeado corretamente: `UC008-list-users-admin.md`
- [x] Libs/helpers criados est√£o documentados (reutiliza auth.ts de UC003)
- [x] Comandos de teste est√£o corretos e testados (smoke/baseline/stress)
- [x] Tags obrigat√≥rias est√£o especificadas (feature: users, kind: admin, uc: UC008)
- [x] M√©tricas customizadas est√£o documentadas (3 Trends + 2 Counters)

---

## üìö Refer√™ncias

- [DummyJSON API Docs](https://dummyjson.com/docs)
- [DummyJSON Users API](https://dummyjson.com/docs/users)
- [DummyJSON Auth API](https://dummyjson.com/docs/auth)
- [k6 Documentation - Scenarios](https://grafana.com/docs/k6/latest/using-k6/scenarios/)
- [k6 Documentation - Checks](https://grafana.com/docs/k6/latest/using-k6/checks/)
- [k6 Documentation - Metrics](https://grafana.com/docs/k6/latest/using-k6/metrics/)
- [k6 jslib - k6-utils](https://jslib.k6.io/k6-utils/1.4.0/index.js)
- Baseline SLOs: `docs/casos_de_uso/fase1-baseline-slos.md`
- Perfis de Usu√°rio: `docs/casos_de_uso/fase1-perfis-de-usuario.md`
- Matriz de Prioriza√ß√£o: `docs/casos_de_uso/fase2-matriz-priorizacao.md`
- Mapa de Depend√™ncias: `docs/casos_de_uso/fase2-mapa-dependencias.md`
- UC003 (User Login): `docs/casos_de_uso/UC003-user-login-profile.md`
